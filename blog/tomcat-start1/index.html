<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Tomcat启动之initInternal · Jemoii's Blog</title><meta name="description" content="Tomcat启动之initInternal - Jemoii"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://g.hijkl.mn/atom.xml" title="Jemoii's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/jemoii" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Tomcat启动之initInternal</h1><div class="post-info">2017年8月30日</div><div class="post-content"><ul>
<li><a href="/blog/tomcat-start0">Tomcat启动之从脚本说起</a></li>
<li>Tomcat启动之initInternal</li>
<li><a href="/blog/tomcat-start2">Tomcat启动之startInternal</a></li>
<li><a href="/blog/tomcat-start3">Tomcat启动之Context启动</a></li>
<li><a href="/blog/tomcat-start4">Tomcat启动之Connector启动</a></li>
</ul>
<p>Bootstrap类在静态块中初始化<code>catalina.home</code>，<code>catalina.base</code>。start方法首先初始化类加载器，common类加载器会搜索<code>conf/catalina.properties</code>中<code>common.loader</code>属性定义的路径下的类，默认配置下，server类加载器、shared类加载器与common类加载器一致。通过反射设置Catalina类的父加载器为shared类加载器。这里先给出如下的<a href="https://tomcat.apache.org/tomcat-8.0-doc/class-loader-howto.html" target="_blank" rel="external">类加载器关系图</a>，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">    Bootstrap</div><div class="line">        |</div><div class="line">     System</div><div class="line">        |</div><div class="line">     Common</div><div class="line">     /     \</div><div class="line">Webapp1   Webapp2 ...</div></pre></td></tr></table></figure>
<p>接着通过反射调用Catalina类的start方法。首先加载<code>conf/server.xml</code>，使用<a href="https://commons.apache.org/proper/commons-digester/" target="_blank" rel="external">Digester</a>解析xml，创建<code>Server</code>实例。<code>server.xml</code>对于理解Tomcat结构至关重要。</p>
<p>下面的示例server.xml去除了注释并做了简化，</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version='1.0' encoding='utf-8'?&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">port</span>=<span class="string">"8005"</span> <span class="attr">shutdown</span>=<span class="string">"SHUTDOWN"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.startup.VersionLoggerListener"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.JreMemoryLeakPreventionListener"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.ThreadLocalLeakPreventionListener"</span> /&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">"Catalina"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8080"</span> <span class="attr">protocol</span>=<span class="string">"HTTP/1.1"</span></span></div><div class="line"><span class="tag">               <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span></span></div><div class="line"><span class="tag">               <span class="attr">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8009"</span> <span class="attr">protocol</span>=<span class="string">"AJP/1.3"</span> <span class="attr">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">"Catalina"</span> <span class="attr">defaultHost</span>=<span class="string">"localhost"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">"localhost"</span>  <span class="attr">appBase</span>=<span class="string">"webapps"</span></span></div><div class="line"><span class="tag">            <span class="attr">unpackWARs</span>=<span class="string">"true"</span> <span class="attr">autoDeploy</span>=<span class="string">"true"</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.valves.AccessLogValve"</span> <span class="attr">directory</span>=<span class="string">"logs"</span></span></div><div class="line"><span class="tag">               <span class="attr">prefix</span>=<span class="string">"localhost_access_log"</span> <span class="attr">suffix</span>=<span class="string">".txt"</span></span></div><div class="line"><span class="tag">               <span class="attr">pattern</span>=<span class="string">"%h %l %u %t &amp;quot;%r&amp;quot; %s %b"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">"/api-server"</span> <span class="attr">debug</span>=<span class="string">"1"</span> <span class="attr">docBase</span>=<span class="string">"/data/webapp/api-server"</span>/&gt;</span></div><div class="line"></div><div class="line">      <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">Service</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></div></pre></td></tr></table></figure>
<p>下面是对org.apache.catalina.startup.Catalina#createStartDigester的注释，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div></pre></td><td class="code"><pre><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * Create and configure the Digester we will be using for startup.</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> Digester <span class="title">createStartDigester</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">long</span> t1=System.currentTimeMillis();</div><div class="line">       <span class="comment">// Initialize the digester</span></div><div class="line">       Digester digester = <span class="keyword">new</span> Digester();</div><div class="line">       digester.setValidating(<span class="keyword">false</span>);</div><div class="line">       digester.setRulesValidation(<span class="keyword">true</span>);</div><div class="line">       HashMap&lt;Class&lt;?&gt;, List&lt;String&gt;&gt; fakeAttributes = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">       ArrayList&lt;String&gt; attrs = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">       attrs.add(<span class="string">"className"</span>);</div><div class="line">       fakeAttributes.put(Object.class, attrs);</div><div class="line">       digester.setFakeAttributes(fakeAttributes);</div><div class="line">       digester.setUseContextClassLoader(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">       <span class="comment">// Configure the actions we will be using</span></div><div class="line">	<span class="comment">// 匹配到Server节点时新建StandardServer实例</span></div><div class="line">	<span class="comment">// 如果存在className属性则使用其指定的类名</span></div><div class="line">       digester.addObjectCreate(<span class="string">"Server"</span>,</div><div class="line">                                <span class="string">"org.apache.catalina.core.StandardServer"</span>,</div><div class="line">                                <span class="string">"className"</span>);</div><div class="line">	<span class="comment">// 将Server节点的属性设置为Server实例对应的属性</span></div><div class="line">       digester.addSetProperties(<span class="string">"Server"</span>);</div><div class="line">	<span class="comment">// 调用Catalina#setServer</span></div><div class="line">       digester.addSetNext(<span class="string">"Server"</span>,</div><div class="line">                           <span class="string">"setServer"</span>,</div><div class="line">                           <span class="string">"org.apache.catalina.Server"</span>);</div><div class="line">	...</div><div class="line">	digester.addObjectCreate(<span class="string">"Server/Listener"</span>,</div><div class="line">                                <span class="keyword">null</span>, <span class="comment">// MUST be specified in the element</span></div><div class="line">                                <span class="string">"className"</span>);</div><div class="line">       digester.addSetProperties(<span class="string">"Server/Listener"</span>);</div><div class="line">	<span class="comment">// 调用StandardServer#addLifecycleListener</span></div><div class="line">       digester.addSetNext(<span class="string">"Server/Listener"</span>,</div><div class="line">                           <span class="string">"addLifecycleListener"</span>,</div><div class="line">                           <span class="string">"org.apache.catalina.LifecycleListener"</span>);</div><div class="line"></div><div class="line">       digester.addObjectCreate(<span class="string">"Server/Service"</span>,</div><div class="line">                                <span class="string">"org.apache.catalina.core.StandardService"</span>,</div><div class="line">                                <span class="string">"className"</span>);</div><div class="line">       digester.addSetProperties(<span class="string">"Server/Service"</span>);</div><div class="line">	<span class="comment">// 调用StandardServer#addService</span></div><div class="line">       digester.addSetNext(<span class="string">"Server/Service"</span>,</div><div class="line">                           <span class="string">"addService"</span>,</div><div class="line">                           <span class="string">"org.apache.catalina.Service"</span>);</div><div class="line">	...</div><div class="line">	<span class="comment">// see ConnectorCreateRule</span></div><div class="line">	<span class="comment">// Connector con = new Connector(attributes.getValue("protocol")); </span></div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="comment">// 匹配到Server/Service/Connector节点时新建Connector实例</span></div><div class="line">	<span class="comment">// protocol属性作为构造方法的参数</span></div><div class="line">	digester.addRule(<span class="string">"Server/Service/Connector"</span>,</div><div class="line">                        <span class="keyword">new</span> ConnectorCreateRule());</div><div class="line">       digester.addRule(<span class="string">"Server/Service/Connector"</span>,</div><div class="line">                        <span class="keyword">new</span> SetAllPropertiesRule(<span class="keyword">new</span> String[]&#123;<span class="string">"executor"</span>&#125;));</div><div class="line">	<span class="comment">// 调用StandardService#addConnector</span></div><div class="line">       digester.addSetNext(<span class="string">"Server/Service/Connector"</span>,</div><div class="line">                           <span class="string">"addConnector"</span>,</div><div class="line">                           <span class="string">"org.apache.catalina.connector.Connector"</span>);</div><div class="line">	...</div><div class="line">	digester.addRuleSet(<span class="keyword">new</span> EngineRuleSet(<span class="string">"Server/Service/"</span>));</div><div class="line">       digester.addRuleSet(<span class="keyword">new</span> HostRuleSet(<span class="string">"Server/Service/Engine/"</span>));</div><div class="line">       digester.addRuleSet(<span class="keyword">new</span> ContextRuleSet(<span class="string">"Server/Service/Engine/Host/"</span>));</div><div class="line">	...</div><div class="line">	<span class="comment">// When the 'engine' is found, set the parentClassLoader.</span></div><div class="line">       digester.addRule(<span class="string">"Server/Service/Engine"</span>,</div><div class="line">                        <span class="keyword">new</span> SetParentClassLoaderRule(parentClassLoader));</div><div class="line">	...</div><div class="line">	<span class="keyword">long</span> t2=System.currentTimeMillis();</div><div class="line">       <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">           log.debug(<span class="string">"Digester for server.xml created "</span> + ( t2-t1 ));</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> (digester);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// EngineRuleSet</span></div><div class="line"><span class="comment">// prefix=Server/Service/</span></div><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addRuleInstances</span><span class="params">(Digester digester)</span> </span>&#123;</div><div class="line"></div><div class="line">       digester.addObjectCreate(prefix + <span class="string">"Engine"</span>,</div><div class="line">                                <span class="string">"org.apache.catalina.core.StandardEngine"</span>,</div><div class="line">                                <span class="string">"className"</span>);</div><div class="line">       digester.addSetProperties(prefix + <span class="string">"Engine"</span>);</div><div class="line">	<span class="comment">// 匹配到Server/Service/Engine节点时新建EngineConfig实例</span></div><div class="line">	<span class="comment">// 如果存在engineConfigClass属性则使用其指定的类名</span></div><div class="line">	<span class="comment">// Add this LifecycleListener to our associated component</span></div><div class="line">       <span class="comment">// c.addLifecycleListener(listener);</span></div><div class="line">	<span class="comment">// 调用StandardEngine#addLifecycleListener绑定监听器</span></div><div class="line">       digester.addRule(prefix + <span class="string">"Engine"</span>,</div><div class="line">                        <span class="keyword">new</span> LifecycleListenerRule</div><div class="line">                        (<span class="string">"org.apache.catalina.startup.EngineConfig"</span>,</div><div class="line">                         <span class="string">"engineConfigClass"</span>));</div><div class="line">	<span class="comment">// 调用StandardService#setContainer(Engine)</span></div><div class="line">       digester.addSetNext(prefix + <span class="string">"Engine"</span>,</div><div class="line">                           <span class="string">"setContainer"</span>,</div><div class="line">                           <span class="string">"org.apache.catalina.Container"</span>);</div><div class="line">	...</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// HostRuleSet</span></div><div class="line"><span class="comment">// prefix=Server/Service/Engine</span></div><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addRuleInstances</span><span class="params">(Digester digester)</span> </span>&#123;</div><div class="line"></div><div class="line">       digester.addObjectCreate(prefix + <span class="string">"Host"</span>,</div><div class="line">                                <span class="string">"org.apache.catalina.core.StandardHost"</span>,</div><div class="line">                                <span class="string">"className"</span>);</div><div class="line">       digester.addSetProperties(prefix + <span class="string">"Host"</span>);</div><div class="line">       digester.addRule(prefix + <span class="string">"Host"</span>,</div><div class="line">                        <span class="keyword">new</span> CopyParentClassLoaderRule());</div><div class="line">	<span class="comment">// 调用StandardHost#addLifecycleListener绑定监听器HostConfig</span></div><div class="line">       digester.addRule(prefix + <span class="string">"Host"</span>,</div><div class="line">                        <span class="keyword">new</span> LifecycleListenerRule</div><div class="line">                        (<span class="string">"org.apache.catalina.startup.HostConfig"</span>,</div><div class="line">                         <span class="string">"hostConfigClass"</span>));</div><div class="line">	<span class="comment">// 调用StandardEngine#addChild</span></div><div class="line">       digester.addSetNext(prefix + <span class="string">"Host"</span>,</div><div class="line">                           <span class="string">"addChild"</span>,</div><div class="line">                           <span class="string">"org.apache.catalina.Container"</span>);</div><div class="line">	...</div><div class="line">	digester.addObjectCreate(prefix + <span class="string">"Host/Valve"</span>,</div><div class="line">                                <span class="keyword">null</span>, <span class="comment">// MUST be specified in the element</span></div><div class="line">                                <span class="string">"className"</span>);</div><div class="line">       digester.addSetProperties(prefix + <span class="string">"Host/Valve"</span>);</div><div class="line">	<span class="comment">// 调用StandardHost#addValve</span></div><div class="line">       digester.addSetNext(prefix + <span class="string">"Host/Valve"</span>,</div><div class="line">                           <span class="string">"addValve"</span>,</div><div class="line">                           <span class="string">"org.apache.catalina.Valve"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ContextRuleSet</span></div><div class="line"><span class="comment">// prefix=Server/Service/Engine/Host</span></div><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addRuleInstances</span><span class="params">(Digester digester)</span> </span>&#123;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (create) &#123;</div><div class="line">           digester.addObjectCreate(prefix + <span class="string">"Context"</span>,</div><div class="line">                   <span class="string">"org.apache.catalina.core.StandardContext"</span>, <span class="string">"className"</span>);</div><div class="line">           digester.addSetProperties(prefix + <span class="string">"Context"</span>);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           digester.addRule(prefix + <span class="string">"Context"</span>, <span class="keyword">new</span> SetContextPropertiesRule());</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (create) &#123;</div><div class="line">		<span class="comment">// 调用StandardContext#addLifecycleListener绑定监听器ContextConfig</span></div><div class="line">           digester.addRule(prefix + <span class="string">"Context"</span>,</div><div class="line">                            <span class="keyword">new</span> LifecycleListenerRule</div><div class="line">                                (<span class="string">"org.apache.catalina.startup.ContextConfig"</span>,</div><div class="line">                                 <span class="string">"configClass"</span>));</div><div class="line">		<span class="comment">// 调用StandardHost#addChild</span></div><div class="line">           digester.addSetNext(prefix + <span class="string">"Context"</span>,</div><div class="line">                               <span class="string">"addChild"</span>,</div><div class="line">                               <span class="string">"org.apache.catalina.Container"</span>);</div><div class="line">       &#125;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的注释可以方便跟读源码，后文会进一步补充说明。下面是Tomcat各组件之间的关系，可以看到所有组件都实现了LifeCycle，LifeCycleBase中定义了init，start，stop，destory方法用于生命周期的管理，相应的留下了initInternal，startInternal，stopInternal，destoryInternal方法由组件去实现。</p>
<p><img src="https://moetu.fastmirror.org/images/2017/09/20/tomcat_uml4ebe2ac9c474a906.jpg" alt=""></p>
<p>首先看一下StandardServer中initInternal方法的实现，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">    <span class="comment">// Populate the extension validator with JARs from common and shared</span></div><div class="line">    <span class="comment">// class loaders</span></div><div class="line">    <span class="keyword">if</span> (getCatalina() != <span class="keyword">null</span>) &#123;</div><div class="line">        ClassLoader cl = getCatalina().getParentClassLoader();</div><div class="line">        <span class="comment">// Walk the class loader hierarchy. Stop at the system class loader.</span></div><div class="line">        <span class="comment">// This will add the shared (if present) and common class loaders</span></div><div class="line">        <span class="keyword">while</span> (cl != <span class="keyword">null</span> &amp;&amp; cl != ClassLoader.getSystemClassLoader()) &#123;</div><div class="line">            <span class="keyword">if</span> (cl <span class="keyword">instanceof</span> URLClassLoader) &#123;</div><div class="line">...</div><div class="line">            &#125;</div><div class="line">            cl = cl.getParent();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// Initialize our defined Services</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; services.length; i++) &#123;</div><div class="line">        services[i].init();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>如果是从<code>org.apache.catalina.startup.Bootstrap</code>启动，由解析server.xml生成的Server实例，会调用<code>getServer().setCatalina(this);</code>。相反，Spring Boot中从<code>org.apache.catalina.startup.Tomcat</code>启动，则getCatalina为null。</p>
<p>接着是初始化Service，从这里以及解析xml时调用StandardServer#addService可以看出，一个Server可以包含多个Service。继续看一下StandardService中initInternal方法的实现，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">      <span class="keyword">if</span> (container != <span class="keyword">null</span>) &#123;</div><div class="line">          container.init();</div><div class="line">      &#125;</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">      <span class="comment">// Initialize our defined Connectors</span></div><div class="line">      <span class="keyword">synchronized</span> (connectorsLock) &#123;</div><div class="line">          <span class="keyword">for</span> (Connector connector : connectors) &#123;</div><div class="line">              <span class="keyword">try</span> &#123;</div><div class="line">                  connector.init();</div><div class="line">		...</div><div class="line">          &#125;</div><div class="line">      &#125;</div></pre></td></tr></table></figure>
<p>Service会接着初始化Engine，Connector，从这里以及解析xml时调用StandardService#addConnector，StandardService#setContainer(Engine)可以看出一个Service可以包含一个Engine以及多个Connector。</p>
<p>实例化StandardEngine时，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Create a new StandardEngine component with the default basic Valve.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">StandardEngine</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">      <span class="keyword">super</span>();</div><div class="line">      pipeline.setBasic(<span class="keyword">new</span> StandardEngineValve());</div><div class="line">...</div><div class="line">      <span class="comment">// By default, the engine will hold the reloading thread</span></div><div class="line">      backgroundProcessorDelay = <span class="number">10</span>;</div><div class="line"></div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>StandardEngine的父类ContainerBase中，initInternal初始化了一个startStopExecutor线程池。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Set the Coyote protocol which will be used by the connector.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> protocol The Coyote protocol name</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProtocol</span><span class="params">(String protocol)</span> </span>&#123;</div><div class="line"></div><div class="line">...</div><div class="line">          <span class="keyword">if</span> (<span class="string">"HTTP/1.1"</span>.equals(protocol)) &#123;</div><div class="line">              setProtocolHandlerClassName</div><div class="line">                  (<span class="string">"org.apache.coyote.http11.Http11NioProtocol"</span>);</div><div class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"AJP/1.3"</span>.equals(protocol)) &#123;</div><div class="line">              setProtocolHandlerClassName</div><div class="line">                  (<span class="string">"org.apache.coyote.ajp.AjpNioProtocol"</span>);</div><div class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (protocol != <span class="keyword">null</span>) &#123;</div><div class="line">              setProtocolHandlerClassName(protocol);</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>解析xml时通过Connector#Connector(String)实例化Connector，所以protocolHandlerClassName为<code>org.apache.coyote.http11.Http11NioProtocol</code>（仅以此为例）。在<code>Tomcat 8.0.0 (markt)</code>的<a href="http://tomcat.apache.org/tomcat-8.0-doc/changelog.html" target="_blank" rel="external">更新日志</a>中可以看到</p>
<blockquote>
<p>The default connector is now the Java NIO connector even when specifying HTTP/1.1 as protocol (fhanik)</p>
</blockquote>
<p>获取，设置Connector的部分属性时，会通过下面的方法获取、设置ProtocolHandler的属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Return a configured property.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getProperty</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">    String repl = name;</div><div class="line">    <span class="keyword">if</span> (replacements.get(name) != <span class="keyword">null</span>) &#123;</div><div class="line">        repl = replacements.get(name);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> IntrospectionUtils.getProperty(protocolHandler, repl);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Set a configured property.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setProperty</span><span class="params">(String name, String value)</span> </span>&#123;</div><div class="line">    String repl = name;</div><div class="line">    <span class="keyword">if</span> (replacements.get(name) != <span class="keyword">null</span>) &#123;</div><div class="line">        repl = replacements.get(name);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> IntrospectionUtils.setProperty(protocolHandler, repl, value);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Connector中的initInternal调用ProtocolHandler#init，这里NioEndpoint的名字设置为<code>http-nio-8080</code>，接着AbstractEndpoint#init会调用NioEndpoint#bind</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Initialize the endpoint.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">      serverSock = ServerSocketChannel.open();</div><div class="line">      socketProperties.setProperties(serverSock.socket());</div><div class="line">      InetSocketAddress addr = (getAddress()!=<span class="keyword">null</span>?<span class="keyword">new</span> InetSocketAddress(getAddress(),getPort()):<span class="keyword">new</span> InetSocketAddress(getPort()));</div><div class="line">      serverSock.socket().bind(addr,getBacklog());</div><div class="line">      serverSock.configureBlocking(<span class="keyword">true</span>); <span class="comment">//mimic APR behavior</span></div><div class="line">      serverSock.socket().setSoTimeout(getSocketProperties().getSoTimeout());</div><div class="line"></div><div class="line">      <span class="comment">// Initialize thread count defaults for acceptor, poller</span></div><div class="line">      <span class="keyword">if</span> (acceptorThreadCount == <span class="number">0</span>) &#123;</div><div class="line">          <span class="comment">// <span class="doctag">FIXME:</span> Doesn't seem to work that well with multiple accept threads</span></div><div class="line">          acceptorThreadCount = <span class="number">1</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (pollerThreadCount &lt;= <span class="number">0</span>) &#123;</div><div class="line">          <span class="comment">//minimum one poller thread</span></div><div class="line">          pollerThreadCount = <span class="number">1</span>;</div><div class="line">      &#125;</div><div class="line">      stopLatch = <span class="keyword">new</span> CountDownLatch(pollerThreadCount);</div><div class="line"></div><div class="line">      <span class="comment">// Initialize SSL if needed</span></div><div class="line">...</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (oomParachute&gt;<span class="number">0</span>) reclaimParachute(<span class="keyword">true</span>);</div><div class="line">      selectorPool.open();</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>实例化serverSocket、Acceptor线程数默认为1，Poller线程数不大于2，stopLatch用于Poller线程计数器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * The size of the OOM parachute.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> oomParachute = <span class="number">1024</span>*<span class="number">1024</span>;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * The oom parachute, when an OOM error happens,</span></div><div class="line"><span class="comment"> * will release the data, giving the JVM instantly</span></div><div class="line"><span class="comment"> * a chunk of data to be able to recover with.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">byte</span>[] oomParachuteData = <span class="keyword">null</span>;</div></pre></td></tr></table></figure>
<p>如果上面的过程一切顺利的话，所有组件完成初始化，进入<code>after_init</code>。</p>
<h4 id="进一步阅读"><a href="#进一步阅读" class="headerlink" title="进一步阅读"></a>进一步阅读</h4><p><a href="http://www.cnblogs.com/kismetv/p/7228274.html" target="_blank" rel="external">http://www.cnblogs.com/kismetv/p/7228274.html</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/blog/tomcat-start2/" class="prev">上一篇</a><a href="/blog/tomcat-start0/" class="next">下一篇</a></div><div class="copyright"><p>© 2014 - 2017 <a href="https://g.hijkl.mn">Jemoii</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>