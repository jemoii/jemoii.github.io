<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Tomcat启动之Context启动 · Jemoii's Blog</title><meta name="description" content="Tomcat启动之Context启动 - Jemoii"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://g.hijkl.mn/atom.xml" title="Jemoii's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/jemoii" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Tomcat启动之Context启动</h1><div class="post-info">2017年8月30日</div><div class="post-content"><ul>
<li><a href="/blog/tomcat-start0">Tomcat启动之从脚本说起</a></li>
<li><a href="/blog/tomcat-start1">Tomcat启动之initInternal</a></li>
<li><a href="/blog/tomcat-start2">Tomcat启动之startInternal</a></li>
<li>Tomcat启动之Context启动</li>
<li><a href="/blog/tomcat-start4">Tomcat启动之Connector启动</a></li>
</ul>
<p>添加到StandardHost的StandardContext启动，看一下StandardContext中startInternal的实现，startInternal中的过程较多，这里仅说明以下过程，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Start this component and implement the requirements</span></div><div class="line"><span class="comment">   * of &#123;<span class="doctag">@link</span> org.apache.catalina.util.LifecycleBase#startInternal()&#125;.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@exception</span> LifecycleException if this component detects a fatal error</span></div><div class="line"><span class="comment">   *  that prevents this component from being used</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line">...</div><div class="line">      <span class="keyword">boolean</span> ok = <span class="keyword">true</span>;</div><div class="line">...</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (getLoader() == <span class="keyword">null</span>) &#123;</div><div class="line">          WebappLoader webappLoader = <span class="keyword">new</span> WebappLoader(getParentClassLoader());</div><div class="line">          webappLoader.setDelegate(getDelegate());</div><div class="line">          setLoader(webappLoader);</div><div class="line">      &#125;</div><div class="line">...</div><div class="line"></div><div class="line">          <span class="keyword">if</span> (ok) &#123;</div><div class="line">              <span class="comment">// Start our subordinate components, if any</span></div><div class="line">              Loader loader = getLoader();</div><div class="line">              <span class="keyword">if</span> ((loader != <span class="keyword">null</span>) &amp;&amp; (loader <span class="keyword">instanceof</span> Lifecycle))</div><div class="line">                  ((Lifecycle) loader).start();</div><div class="line">		...</div><div class="line"></div><div class="line">              <span class="comment">// Notify our interested LifecycleListeners</span></div><div class="line">              fireLifecycleEvent(Lifecycle.CONFIGURE_START_EVENT, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">              <span class="comment">// Start our child containers, if not already started</span></div><div class="line">              <span class="keyword">for</span> (Container child : findChildren()) &#123;</div><div class="line">                  <span class="keyword">if</span> (!child.getState().isAvailable()) &#123;</div><div class="line">                      child.start();</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line"></div><div class="line">              <span class="comment">// Start the Valves in our pipeline (including the basic),</span></div><div class="line">              <span class="comment">// if any</span></div><div class="line">              <span class="keyword">if</span> (pipeline <span class="keyword">instanceof</span> Lifecycle) &#123;</div><div class="line">                  ((Lifecycle) pipeline).start();</div><div class="line">              &#125;</div><div class="line">		...</div><div class="line">          &#125;</div><div class="line">	...</div><div class="line"></div><div class="line">          <span class="comment">// Load and initialize all "load on startup" servlets</span></div><div class="line">          <span class="keyword">if</span> (ok) &#123;</div><div class="line">              <span class="keyword">if</span> (!loadOnStartup(findChildren()))&#123;</div><div class="line">                  log.error(sm.getString(<span class="string">"standardContext.servletFail"</span>));</div><div class="line">                  ok = <span class="keyword">false</span>;</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">...</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>默认情况下getParentClassLoader方法返回父Container即StandardHost的parentClassLoader，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Return the parent class loader (if any) for this web application.</span></div><div class="line"><span class="comment"> * This call is meaningful only &lt;strong&gt;after&lt;/strong&gt; a Loader has</span></div><div class="line"><span class="comment"> * been configured.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ClassLoader <span class="title">getParentClassLoader</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (parentClassLoader != <span class="keyword">null</span>)</div><div class="line">        <span class="keyword">return</span> (parentClassLoader);</div><div class="line">    <span class="keyword">if</span> (getPrivileged()) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getClass().getClassLoader();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> (parent.getParentClassLoader());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> (ClassLoader.getSystemClassLoader());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里需要重新回顾一下解析server.xml</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// When the 'engine' is found, set the parentClassLoader.</span></div><div class="line">      digester.addRule(<span class="string">"Server/Service/Engine"</span>,</div><div class="line">                       <span class="keyword">new</span> SetParentClassLoaderRule(parentClassLoader));</div><div class="line"></div><div class="line"><span class="comment">// prefix=Server/Service/Engine</span></div><div class="line">digester.addRule(prefix + <span class="string">"Host"</span>,</div><div class="line">                       <span class="keyword">new</span> CopyParentClassLoaderRule());</div></pre></td></tr></table></figure>
<p>StandardEngine的parentClassLoader被设置为Catalina的parentClassLoader即最初的sharedLoader。StandardHost的parentClassLoader被设置为StandardEngine的parentClassLoader，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * Start associated &#123;<span class="doctag">@link</span> ClassLoader&#125; and implement the requirements</span></div><div class="line"><span class="comment">    * of &#123;<span class="doctag">@link</span> org.apache.catalina.util.LifecycleBase#startInternal()&#125;.</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * <span class="doctag">@exception</span> LifecycleException if this component detects a fatal error</span></div><div class="line"><span class="comment">    *  that prevents this component from being used</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line">	...</div><div class="line"></div><div class="line">       <span class="comment">// Construct a class loader based on our current repositories list</span></div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line"></div><div class="line">           classLoader = createClassLoader();</div><div class="line">           classLoader.setResources(context.getResources());</div><div class="line">           classLoader.setDelegate(<span class="keyword">this</span>.delegate);</div><div class="line"></div><div class="line">           <span class="comment">// Configure our repositories</span></div><div class="line">           setClassPath();</div><div class="line"></div><div class="line">           setPermissions();</div><div class="line"></div><div class="line">           ((Lifecycle) classLoader).start();</div><div class="line"></div><div class="line">	...</div><div class="line">   &#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    * Create associated classLoader.</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="function"><span class="keyword">private</span> WebappClassLoaderBase <span class="title">createClassLoader</span><span class="params">()</span></span></div><div class="line"><span class="function">       <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">       Class&lt;?&gt; clazz = Class.forName(loaderClass);</div><div class="line">       WebappClassLoaderBase classLoader = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (parentClassLoader == <span class="keyword">null</span>) &#123;</div><div class="line">           parentClassLoader = context.getParentClassLoader();</div><div class="line">       &#125;</div><div class="line">       Class&lt;?&gt;[] argTypes = &#123; ClassLoader.class &#125;;</div><div class="line">       Object[] args = &#123; parentClassLoader &#125;;</div><div class="line">       Constructor&lt;?&gt; constr = clazz.getConstructor(argTypes);</div><div class="line">       classLoader = (WebappClassLoaderBase) constr.newInstance(args);</div><div class="line"></div><div class="line">       <span class="keyword">return</span> classLoader;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>When a request to load a class from the web application’s WebappX class loader is processed, this class loader will look in the local repositories <strong>first</strong>, instead of delegating before looking.</p>
</blockquote>
<p>org.apache.catalina.loader.WebappClassLoaderBase#loadClass(String, boolean)</p>
<blockquote>
<p>Load the class with the specified name, searching using the following algorithm until it finds and returns the class. If the class cannot be found, returns ClassNotFoundException.</p>
<ul>
<li>Call findLoadedClass(String) to check if the class has already been loaded. If it has, the same Class object is returned.</li>
<li>If the delegate property is set to true, call the loadClass() method of the parent class loader, if any.</li>
<li>Call findClass() to find this class in our locally defined repositories.</li>
<li>Call the loadClass() method of our parent class loader, if any.</li>
</ul>
<p>If the class was found using the above steps, and the resolve flag is true, this method will then call resolveClass(Class) on the resulting Class object.</p>
</blockquote>
<p>解析xml时为StandardContext绑定了监听器ContextConfig，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Process events for an associated Context.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> event The lifecycle event that has occurred</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lifecycleEvent</span><span class="params">(LifecycleEvent event)</span> </span>&#123;</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">      <span class="comment">// Process the event that has occurred</span></div><div class="line">      <span class="keyword">if</span> (event.getType().equals(Lifecycle.CONFIGURE_START_EVENT)) &#123;</div><div class="line">          configureStart();</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType().equals(Lifecycle.BEFORE_START_EVENT)) &#123;</div><div class="line">          beforeStart();</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType().equals(Lifecycle.AFTER_START_EVENT)) &#123;</div><div class="line">          <span class="comment">// Restore docBase for management tools</span></div><div class="line">          <span class="keyword">if</span> (originalDocBase != <span class="keyword">null</span>) &#123;</div><div class="line">              context.setDocBase(originalDocBase);</div><div class="line">          &#125;</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType().equals(Lifecycle.CONFIGURE_STOP_EVENT)) &#123;</div><div class="line">          configureStop();</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType().equals(Lifecycle.AFTER_INIT_EVENT)) &#123;</div><div class="line">          init();</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType().equals(Lifecycle.AFTER_DESTROY_EVENT)) &#123;</div><div class="line">          destroy();</div><div class="line">      &#125;</div><div class="line"></div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p><code>after_init</code>事件会触发init方法，用于准备解析web.xml。主要看一下<code>configure_start</code>事件触发的configureStart方法，解析web.xml，将Servlet包装为StandardWrapper实例，添加到StandardContext的子Container。其他会作为属性设置StandardContext的属性。</p>
<blockquote>
<p>org.apache.catalina.startup.ContextConfig#webConfig</p>
</blockquote>
<p>org.apache.catalina.core.StandardContext#loadOnStartup会按照loadOnStartup对StandardWrapper进行分组，然后分组调用load方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Load and initialize an instance of this servlet, if there is not already</span></div><div class="line"><span class="comment">   * at least one initialized instance.  This can be used, for example, to</span></div><div class="line"><span class="comment">   * load servlets that are marked in the deployment descriptor to be loaded</span></div><div class="line"><span class="comment">   * at server startup time.</span></div><div class="line"><span class="comment">   * &lt;p&gt;</span></div><div class="line"><span class="comment">   * &lt;b&gt;IMPLEMENTATION NOTE&lt;/b&gt;:  Servlets whose classnames begin with</span></div><div class="line"><span class="comment">   * &lt;code&gt;org.apache.catalina.&lt;/code&gt; (so-called "container" servlets)</span></div><div class="line"><span class="comment">   * are loaded by the same classloader that loaded this class, rather than</span></div><div class="line"><span class="comment">   * the classloader for the current web application.</span></div><div class="line"><span class="comment">   * This gives such classes access to Catalina internals, which are</span></div><div class="line"><span class="comment">   * prevented for classes loaded for web applications.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@exception</span> ServletException if the servlet init() method threw</span></div><div class="line"><span class="comment">   *  an exception</span></div><div class="line"><span class="comment">   * <span class="doctag">@exception</span> ServletException if some other loading problem occurs</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> <span class="keyword">throws</span> ServletException </span>&#123;</div><div class="line">      instance = loadServlet();</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (!instanceInitialized) &#123;</div><div class="line">          initServlet(instance);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">...</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>根据servletClass反射得到Servlet实例，触发监听器，调用其init方法</p>
<p>至此Container相关的组件启动完成。</p>
</div></article></div></main><footer><div class="paginator"><a href="/blog/tomcat-start4/" class="prev">上一篇</a><a href="/blog/tomcat-start2/" class="next">下一篇</a></div><div class="copyright"><p>© 2014 - 2017 <a href="https://g.hijkl.mn">Jemoii</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>