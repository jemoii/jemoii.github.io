<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 对HashMap类的解释 · Jemoii's Blog</title><meta name="description" content="对HashMap类的解释 - Jemoii"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://g.hijkl.mn/atom.xml" title="Jemoii's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/jemoii" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">对HashMap类的解释</h1><div class="post-info">2014年11月10日</div><div class="post-content"><h4 id="内部接口Entry中存放键-值对（key-value-pair）"><a href="#内部接口Entry中存放键-值对（key-value-pair）" class="headerlink" title="内部接口Entry中存放键/值对（key value pair）"></a>内部接口Entry中存放键/值对（key value pair）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span> <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">        <span class="keyword">final</span> K key;</div><div class="line">        V value;</div><div class="line">        Entry next;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> hash;</div><div class="line">        <span class="comment">//剩余代码未列出</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="put-方法的内部实现代码："><a href="#put-方法的内部实现代码：" class="headerlink" title="put()方法的内部实现代码："></a>put()方法的内部实现代码：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span>)</div><div class="line">    <span class="keyword">return</span> putForNullKey(value);</div><div class="line">    <span class="keyword">int</span> hash = hash(key.hashCode());</div><div class="line">    <span class="keyword">int</span> i = indexFor(hash, table.length);</div><div class="line">    <span class="keyword">for</span> (Entry&lt;k , V&gt;; e = table[i]; e != <span class="keyword">null</span>; e = e.next) &#123;</div><div class="line">        Object k;</div><div class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;</div><div class="line">            V oldValue = e.value;</div><div class="line">            e.value = value;</div><div class="line">            e.recordAccess(<span class="keyword">this</span>);</div><div class="line">            <span class="keyword">return</span> oldValue;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    modCount++;</div><div class="line">    addEntry(hash, key, value, i);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="put-方法的解释："><a href="#put-方法的解释：" class="headerlink" title="put()方法的解释："></a>put()方法的解释：</h5><ul>
<li>检查key是否为null，如果key为null，value被存放在table[0]，因为null的散列值始终为0。</li>
<li>以key的散列值作为参数，调用hashCode()方法，计算得到一个散列值。这个散列值将被用来计算Entry对象在数组中的下标。JDK的设计者假定这里可能会有糟糕的hashCode()方法，为了解决这个问题，他们介绍了另外一个hash()方法，将对象的散列值传递给这个方法，得到更加合适的散列值。</li>
<li>调用indexFor(hash, table.length)方法，计算Entry对象在数组中的确切下标。</li>
<li>两个不相等的对象可以有相同的散列值，两个不相等的对象是怎样被存放在数组的相同位置（该位置称为bucket）？答案是链表。Entry类有一个“next”属性，用来指向链中的下一个对象。所以，如果对象发生冲突，Entry对象就被存放在链表中。</li>
<li>当Entry对象需要被存入一个特定的下标时，HashMap会检查该下标处是否已经有一个Entry对象：<ul>
<li>如果还没有，Entry对象会被存入这个位置；</li>
<li>如果已经有，则检查它的“next”属性：<ul>
<li>如果为null，当前Entry对象将作为其下一节点；</li>
<li>如果不为null，程序会保持跟随，直到其为null。</li>
</ul>
</li>
</ul>
</li>
<li>如果已经添加了另一个具有相同key的value作为Entry对象，逻辑上，它应该替换旧的value。是怎样做的？在决定Entry对象在数组中的下标后，HashMap会调用每个Entry对象的equals()方法。在链表中的所有Entry对象会具有相似的散列值，但equals()方法会做出判断。如果equals(k)的结果为true，两个key将会被看做相等的key对象。这将导致仅Entry中的value对象被替换。这样，HashMap就确保了key的唯一性。</li>
</ul>
<h4 id="get-方法的内部实现代码："><a href="#get-方法的内部实现代码：" class="headerlink" title="get()方法的内部实现代码："></a>get()方法的内部实现代码：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span>)</div><div class="line">        <span class="keyword">return</span> getForNullKey();</div><div class="line">    <span class="keyword">int</span> hash = hash(key.hashCode());</div><div class="line">     <span class="keyword">for</span> (Entry&lt;k , V&gt; e = table[indexFor(hash, table.length)]; e != <span class="keyword">null</span>; e = e.next) &#123;</div><div class="line">        Object k;</div><div class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k)))</div><div class="line">            <span class="keyword">return</span> e.value;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意条件：<code>e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))</code>。</p>
<h4 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h4><p><a href="http://howtodoinjava.com/2012/10/09/how-hashmap-works-in-java/" target="_blank" rel="external">How HashMap works in Java</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/blog/hashcode-and-equals/" class="prev">上一篇</a><a href="/blog/the-evaluation-of-expression/" class="next">下一篇</a></div><div class="copyright"><p>© 2014 - 2017 <a href="https://g.hijkl.mn">Jemoii</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>