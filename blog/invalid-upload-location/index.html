<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> The temporary upload location is not valid · Jemoii's Blog</title><meta name="description" content="The temporary upload location is not valid - Jemoii"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://g.hijkl.mn/atom.xml" title="Jemoii's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/jemoii" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">The temporary upload location is not valid</h1><div class="post-info">2017年8月2日</div><div class="post-content"><p>在使用基于Spring Boot的web服务上传文件时会遇到如下异常，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">2017-08-02 08:50:01.518 ERROR 14062 --- [http-nio-8090-exec-3] o.a.c.c.C.[.[.[/].[dispatcherServlet]    : Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is org.springframework.web.multipart.MultipartException: Could not parse multipart servlet request; nested exception is java.io.IOException: The temporary upload location [/tmp/tomcat.5135536038560092961.8080/work/Tomcat/localhost/ROOT] is not valid] with root cause</div><div class="line"></div><div class="line">java.io.IOException: The temporary upload location [/tmp/tomcat.5135536038560092961.8080/work/Tomcat/localhost/ROOT] is not valid</div><div class="line">	at org.apache.catalina.connector.Request.parseParts(Request.java:2758) ~[tomcat-embed-core-8.0.36.jar!/:8.0.36]</div><div class="line">	at org.apache.catalina.connector.Request.parseParameters(Request.java:3158) ~[tomcat-embed-core-8.0.36.jar!/:8.0.36]</div><div class="line">	at org.apache.catalina.connector.Request.getParameter(Request.java:1108) ~[tomcat-embed-core-8.0.36.jar!/:8.0.36]</div><div class="line">	at org.apache.catalina.connector.RequestFacade.getParameter(RequestFacade.java:380) ~[tomcat-embed-core-8.0.36.jar!/:8.0.36]</div><div class="line">	at org.springframework.web.filter.HiddenHttpMethodFilter.doFilterInternal(HiddenHttpMethodFilter.java:70) ~[spring-web-4.2.7.RELEASE.jar!/:4.2.7.RELEASE]</div><div class="line">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107) ~[spring-web-4.2.7.RELEASE.jar!/:4.2.7.RELEASE]</div><div class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240) ~[tomcat-embed-core-8.0.36.jar!/:8.0.36]</div><div class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207) ~[tomcat-embed-core-8.0.36.jar!/:8.0.36]</div><div class="line">	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:121) ~[spring-web-4.2.7.RELEASE.jar!/:4.2.7.RELEASE]</div><div class="line">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107) ~[spring-web-4.2.7.RELEASE.jar!/:4.2.7.RELEASE]</div><div class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240) ~[tomcat-embed-core-8.0.36.jar!/:8.0.36]</div><div class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207) ~[tomcat-embed-core-8.0.36.jar!/:8.0.36]</div><div class="line">	at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:212) ~[tomcat-embed-core-8.0.36.jar!/:8.0.36]</div><div class="line">	at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:106) [tomcat-embed-core-8.0.36.jar!/:8.0.36]</div><div class="line">	at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:502) [tomcat-embed-core-8.0.36.jar!/:8.0.36]</div><div class="line">	at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:141) [tomcat-embed-core-8.0.36.jar!/:8.0.36]</div><div class="line">	at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:79) [tomcat-embed-core-8.0.36.jar!/:8.0.36]</div><div class="line">	at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:88) [tomcat-embed-core-8.0.36.jar!/:8.0.36]</div><div class="line">	at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:528) [tomcat-embed-core-8.0.36.jar!/:8.0.36]</div><div class="line">	at org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1099) [tomcat-embed-core-8.0.36.jar!/:8.0.36]</div><div class="line">	at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:670) [tomcat-embed-core-8.0.36.jar!/:8.0.36]</div><div class="line">	at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1520) [tomcat-embed-core-8.0.36.jar!/:8.0.36]</div><div class="line">	at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1476) [tomcat-embed-core-8.0.36.jar!/:8.0.36]</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) [na:1.7.0_131]</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) [na:1.7.0_131]</div><div class="line">	at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61) [tomcat-embed-core-8.0.36.jar!/:8.0.36]</div><div class="line">	at java.lang.Thread.run(Thread.java:745) [na:1.7.0_131]</div></pre></td></tr></table></figure>
<p>三种解决方式，</p>
<ol>
<li>重启服务；</li>
<li>创建这个不存在的临时路径；</li>
<li>类似如下修改，<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="function">MultipartConfigElement <span class="title">multipartConfigElement</span><span class="params">()</span> </span>&#123;</div><div class="line">    MultipartConfigFactory factory = <span class="keyword">new</span> MultipartConfigFactory();</div><div class="line">    factory.setLocation(<span class="string">"/tmp/file"</span>);</div><div class="line">    <span class="keyword">return</span> factory.createMultipartConfig();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p><code>/tmp/tomcat.5135536038560092961.8080/work/Tomcat/localhost/ROOT</code>这个路径是怎么来的呢？为什么设置location也可以解决异常呢？</p>
<p>接下来就通过跟读源码解释这些疑问。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> EmbeddedServletContainer <span class="title">getEmbeddedServletContainer</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params">		ServletContextInitializer... initializers)</span> </span>&#123;</div><div class="line">	Tomcat tomcat = <span class="keyword">new</span> Tomcat();</div><div class="line">	File baseDir = (<span class="keyword">this</span>.baseDirectory != <span class="keyword">null</span> ? <span class="keyword">this</span>.baseDirectory</div><div class="line">			: createTempDir(<span class="string">"tomcat"</span>));</div><div class="line">	tomcat.setBaseDir(baseDir.getAbsolutePath());</div><div class="line">	Connector connector = <span class="keyword">new</span> Connector(<span class="keyword">this</span>.protocol);</div><div class="line">	tomcat.getService().addConnector(connector);</div><div class="line">	...</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Returns the absolute temp dir for given servlet container.</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> prefix servlet container name</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> The temp dir for given servlet container.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">protected</span> File <span class="title">createTempDir</span><span class="params">(String prefix)</span> </span>&#123;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		File tempDir = File.createTempFile(prefix + <span class="string">"."</span>, <span class="string">"."</span> + getPort());</div><div class="line">		tempDir.delete();</div><div class="line">		tempDir.mkdir();</div><div class="line">		tempDir.deleteOnExit();</div><div class="line">		<span class="keyword">return</span> tempDir;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> EmbeddedServletContainerException(</div><div class="line">				<span class="string">"Unable to create tempDir. java.io.tmpdir is set to "</span></div><div class="line">						+ System.getProperty(<span class="string">"java.io.tmpdir"</span>),</div><div class="line">				ex);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>内嵌Tomcat启动，org.springframework.boot.context.embedded.tomcat.TomcatEmbeddedServletContainerFactory#getEmbeddedServletContainer中，baseDirectory为null时，<code>tomcat.</code>为前缀，<code>.8080</code>为后缀，使用File#createTempFile创建临时路径（前后缀中间为一个Long型随机数），得到<code>/tmp/tomcat.5135536038560092961.8080</code>，并设置为baseDir。org.apache.catalina.startup.Tomcat#getService会触发org.apache.catalina.startup.Tomcat#initBaseDir。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">File baseFile = <span class="keyword">new</span> File(basedir);</div><div class="line">baseFile.mkdirs();</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    baseFile = baseFile.getCanonicalFile();</div><div class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">    baseFile = baseFile.getAbsoluteFile();</div><div class="line">&#125;</div><div class="line">server.setCatalinaBase(baseFile);</div><div class="line">System.setProperty(Globals.CATALINA_BASE_PROP, baseFile.getPath());</div><div class="line">basedir = baseFile.getPath();</div><div class="line"></div><div class="line"><span class="keyword">if</span> (catalinaHome == <span class="keyword">null</span>) &#123;</div><div class="line">    server.setCatalinaHome(baseFile);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    File homeFile = <span class="keyword">new</span> File(catalinaHome);</div><div class="line">    homeFile.mkdirs();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        homeFile = homeFile.getCanonicalFile();</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">        homeFile = homeFile.getAbsoluteFile();</div><div class="line">    &#125;</div><div class="line">    server.setCatalinaHome(homeFile);</div><div class="line">&#125;</div><div class="line">System.setProperty(Globals.CATALINA_HOME_PROP,</div><div class="line">        server.getCatalinaHome().getPath());</div></pre></td></tr></table></figure>
<p>initBaseDir中<code>catalina.home</code>，<code>catalina.base</code>被设置为上面创建的临时路径。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">               workDir = <span class="string">"work"</span> + File.separator + engineName +</div><div class="line">                   File.separator + hostName + File.separator + temp;</div><div class="line">           &#125;</div><div class="line">           setWorkDir(workDir);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// Create this directory if necessary</span></div><div class="line">       File dir = <span class="keyword">new</span> File(workDir);</div><div class="line">       <span class="keyword">if</span> (!dir.isAbsolute()) &#123;</div><div class="line">           String catalinaHomePath = <span class="keyword">null</span>;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               catalinaHomePath = getCatalinaBase().getCanonicalPath();</div><div class="line">               dir = <span class="keyword">new</span> File(catalinaHomePath, workDir);</div><div class="line">           &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">               log.warn(sm.getString(<span class="string">"standardContext.workCreateException"</span>,</div><div class="line">                       workDir, catalinaHomePath, getName()), e);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (!dir.mkdirs() &amp;&amp; !dir.isDirectory()) &#123;</div><div class="line">           log.warn(sm.getString(<span class="string">"standardContext.workCreateFail"</span>, dir,</div><div class="line">                   getName()));</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// Set the appropriate servlet context attribute</span></div><div class="line">       <span class="keyword">if</span> (context == <span class="keyword">null</span>) &#123;</div><div class="line">           getServletContext();</div><div class="line">       &#125;</div><div class="line">       context.setAttribute(ServletContext.TEMPDIR, dir);</div><div class="line">       context.setAttributeReadOnly(ServletContext.TEMPDIR);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>org.apache.catalina.core.StandardContext启动时，postWorkDirectory中得到工作路径<code>work/Tomcat/localhost/ROOT</code>，并将<code>javax.servlet.context.tempdir</code>设置为<code>/tmp/tomcat.5135536038560092961.8080/work/Tomcat/localhost/ROOT</code>。到这里我们解释了这个临时路径是怎么来的。重启服务会创建新的临时路径，和手动创建不存在的临时路径的效果是相同的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">File location;</div><div class="line">String locationStr = mce.getLocation();</div><div class="line"><span class="keyword">if</span> (locationStr == <span class="keyword">null</span> || locationStr.length() == <span class="number">0</span>) &#123;</div><div class="line">	location = ((File) context.getServletContext().getAttribute(</div><div class="line">			ServletContext.TEMPDIR));</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">	<span class="comment">// If relative, it is relative to TEMPDIR</span></div><div class="line">	location = <span class="keyword">new</span> File(locationStr);</div><div class="line">	<span class="keyword">if</span> (!location.isAbsolute()) &#123;</div><div class="line">		location = <span class="keyword">new</span> File(</div><div class="line">				(File) context.getServletContext().getAttribute(</div><div class="line">							ServletContext.TEMPDIR),</div><div class="line">							locationStr).getAbsoluteFile();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (!location.isDirectory()) &#123;</div><div class="line">	parameters.setParseFailedReason(FailReason.MULTIPART_CONFIG_INVALID);</div><div class="line">	partsParseException = <span class="keyword">new</span> IOException(</div><div class="line">			sm.getString(<span class="string">"coyoteRequest.uploadLocationInvalid"</span>,</div><div class="line">					location));</div><div class="line">	<span class="keyword">return</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>org.apache.catalina.connector.Request#parseParts中，location无效时，使用<code>javax.servlet.context.tempdir</code>属性值。设置location相当于替换了临时路径，所以可以解决问题，但是这种解决方式并不完美，</p>
<blockquote>
<p>The definition of absolute pathname is system dependent. On UNIX systems, a pathname is absolute if its prefix is “/“. On Microsoft Windows systems, a pathname is absolute if its prefix is a drive specifier followed by “\“, or if its prefix is “\\“.</p>
</blockquote>
<p>如果在Windows上将location设置为<code>/tmp/file</code>，location实际为<code>/tmp/tomcat.5135536038560092961.8080/work/Tomcat/localhost/ROOT/tmp/file</code>，有可能出现相同的异常。</p>
<p>回到开始，baseDirectory为null时会创建临时路径，location无效时会使用临时路径，设置location又面临系统差异的问题，那如果设置baseDirectory而不是设置location可以更好的解决问题。</p>
<p>相关文章中都会提到<em>服务长时间未使用</em>，那服务又为什么长时间未使用呢？</p>
<p>参考文档：</p>
<p><a href="http://wuzhaoyang.me/2017/06/07/spring-multipartexception-location-not-valid.html" target="_blank" rel="external">http://wuzhaoyang.me/2017/06/07/spring-multipartexception-location-not-valid.html</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/blog/tomcat-start0/" class="prev">上一篇</a><a href="/blog/aop/" class="next">下一篇</a></div><div class="copyright"><p>© 2014 - 2017 <a href="https://g.hijkl.mn">Jemoii</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>