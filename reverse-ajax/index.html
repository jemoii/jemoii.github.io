<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 使用DWR实现消息推送 · Jemoii's Blog</title><meta name="description" content="使用DWR实现消息推送 - Jemoii"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://g.hijkl.mn/atom.xml" title="Jemoii's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/jemoii" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">使用DWR实现消息推送</h1><div class="post-info">2015年11月21日</div><div class="post-content"><p>dwr支持如下3种模式的消息推送：</p>
<ul>
<li>Polling，浏览器每隔一段时间向服务器发出请求，查看是否有更新的内容；</li>
<li>Comet，</li>
<li>Piggyback，服务器等待浏览器下一次发出请求时，将更新的内容合并到响应一起返回。</li>
</ul>
<p>默认使用Piggyback模式，使用Polling/Comet模式需要额外的配置。</p>
<blockquote>
<p>   <a href="http://jemoii.github.io/blog/getting-started-with-dwr/" target="_blank" rel="external">DWR简单入门</a>介绍了基于DWR构建项目。</p>
</blockquote>
<p>使用Maven构建项目，在pom.xml中添加如下配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">repository</span>&gt;</span></div><div class="line">		<span class="comment">&lt;!-- Please consider setting up your own on-site repository proxy such </span></div><div class="line"><span class="comment">			as with Nexus and pointing the url element below at that instead --&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">id</span>&gt;</span>oss-sonatype-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>OSS Sonatype Snapshots Repository<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">url</span>&gt;</span>http://oss.sonatype.org/content/repositories/snapshots<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">releases</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">releases</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">repository</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">...</div><div class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.directwebremoting<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dwr<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 使用Tomcat需要额外添加的依赖包 --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>catalina<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.44<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure>
<p>使用的容器是Tomcat（与使用Jetty的配置不同），在web.xml中添加如下配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>dwr-invoker<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.directwebremoting.server.tomcat.DwrCometProcessor<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">param-name</span>&gt;</span>debug<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">    	<span class="comment">&lt;!-- 2.0 RC3之前的参数名为pollAndCometEnabled --&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">param-name</span>&gt;</span>activeReverseAjaxEnabled<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">param-name</span>&gt;</span>maxWaitAfterWrite<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">param-value</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>dwr-invoker<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/dwr/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></div></pre></td></tr></table></figure>
<p>dwr.xml中的配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE dwr PUBLIC</span></div><div class="line"><span class="meta">    "-//GetAhead Limited//DTD Direct Web Remoting 3.0//EN"</span></div><div class="line"><span class="meta">    "http://getahead.org/dwr/dwr30.dtd"&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dwr</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">allow</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">create</span> <span class="attr">creator</span>=<span class="string">"new"</span> <span class="attr">javascript</span>=<span class="string">"messagePush"</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"class"</span> <span class="attr">value</span>=<span class="string">"me.util.MessagePushUtil"</span> /&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">create</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">allow</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dwr</span>&gt;</span></div></pre></td></tr></table></figure>
<p>采用的调试方式是，打开接收页面（receiver.jsp）和发送页面（sender.jsp），在发送页面将消息发送至服务端，由服务端将消息推送至接受页面。JSP文件中使用<code>JQuery</code>替代了dwr提供的<code>&lt;script type=&#39;text/javascript&#39; src=&#39;/dwr/util.js&#39;&gt;&lt;/script&gt;</code>。</p>
<p>接收页面（receiver.jsp）<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">&lt;%@ page language=<span class="string">"java"</span> contentType=<span class="string">"text/html; charset=UTF-8"</span></div><div class="line">	pageEncoding=<span class="string">"UTF-8"</span>%&gt;</div><div class="line">&lt;%@ page isELIgnored=<span class="string">"false"</span>%&gt;</div><div class="line">&lt;%@ taglib prefix=<span class="string">"c"</span> uri=<span class="string">"http://java.sun.com/jsp/jstl/core"</span>%&gt;</div><div class="line">&lt;!DOCTYPE html PUBLIC <span class="string">"-//W3C//DTD HTML 4.01 Transitional//EN"</span> <span class="string">"http://www.w3.org/TR/html4/loose.dtd"</span>&gt;</div><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">&lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=UTF-8"</span>&gt;</div><div class="line">&lt;link rel=<span class="string">"stylesheet"</span> type=<span class="string">"text/css"</span> href=<span class="string">"/css/easyui.css"</span>&gt;</div><div class="line">&lt;link rel=<span class="string">"stylesheet"</span> type=<span class="string">"text/css"</span> href=<span class="string">"/css/demo.css"</span>&gt;</div><div class="line">&lt;script type="text/javascript" src="/js/jquery.js"&gt;&lt;/script&gt;</div><div class="line">&lt;script type="text/javascript" src="/js/jquery.easyui.min.js"&gt;&lt;/script&gt;</div><div class="line">&lt;script type='text/javascript' src='/dwr/engine.js'&gt;&lt;/script&gt;</div><div class="line">&lt;script type='text/javascript' src='/dwr/interface/messagePush.js'&gt;&lt;/script&gt;</div><div class="line">&lt;title&gt;消息推送&lt;/title&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">	&lt;h2&gt;接受消息推送&lt;/h2&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;script&gt;</div><div class="line">	$(function() &#123;</div><div class="line">		dwr.engine.setActiveReverseAjax(<span class="keyword">true</span>);</div><div class="line">        dwr.engine.setNotifyServerOnPageUnload(<span class="keyword">true</span>);</div><div class="line">        messagePush.onPageLoad(<span class="string">'&#123;sessionScope.uid&#125;'</span>);</div><div class="line">	&#125;);</div><div class="line"></div><div class="line">    <span class="function">function <span class="title">showMessage</span><span class="params">(autoMessage)</span> </span>&#123;</div><div class="line">		$.messager.show(&#123;</div><div class="line">			title : <span class="string">"消息推送"</span>,</div><div class="line">			msg : autoMessage,</div><div class="line">			showType : <span class="string">'slide'</span>,</div><div class="line">			timeout : <span class="number">5000</span></div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line">&lt;/script&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<p>发送页面（sender.jsp）<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">&lt;%@ page language=<span class="string">"java"</span> contentType=<span class="string">"text/html; charset=UTF-8"</span></div><div class="line">	pageEncoding=<span class="string">"UTF-8"</span>%&gt;</div><div class="line">&lt;%@ page isELIgnored=<span class="string">"false"</span>%&gt;</div><div class="line">&lt;%@ taglib prefix=<span class="string">"c"</span> uri=<span class="string">"http://java.sun.com/jsp/jstl/core"</span>%&gt;</div><div class="line">&lt;!DOCTYPE html PUBLIC <span class="string">"-//W3C//DTD HTML 4.01 Transitional//EN"</span> <span class="string">"http://www.w3.org/TR/html4/loose.dtd"</span>&gt;</div><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">&lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=UTF-8"</span>&gt;</div><div class="line">&lt;link rel=<span class="string">"stylesheet"</span> type=<span class="string">"text/css"</span> href=<span class="string">"./css/easyui.css"</span>&gt;</div><div class="line">&lt;link rel=<span class="string">"stylesheet"</span> type=<span class="string">"text/css"</span> href=<span class="string">"./css/demo.css"</span>&gt;</div><div class="line">&lt;script type="text/javascript" src="./js/jquery.js"&gt;&lt;/script&gt;</div><div class="line">&lt;script type="text/javascript" src="./js/jquery.easyui.min.js"&gt;&lt;/script&gt;</div><div class="line">&lt;script type='text/javascript' src='/dwr/engine.js'&gt;&lt;/script&gt;</div><div class="line">&lt;script type='text/javascript' src='/dwr/interface/messagePush.js'&gt;&lt;/script&gt;</div><div class="line">&lt;title&gt;消息推送&lt;/title&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">	&lt;h2&gt;发送消息推送&lt;/h2&gt;</div><div class="line">	&lt;div id=<span class="string">"p"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"easyui-panel"</span></div><div class="line">		style=<span class="string">"width: 400px; height: 100x; padding: 10px;"</span>&gt;</div><div class="line">		&lt;div&gt;</div><div class="line">			ID：&lt;input id=<span class="string">"uid"</span> style=<span class="string">"width: 40%; height: 25px"</span>&gt;消息：&lt;input</div><div class="line">				id=<span class="string">"msg"</span> style=<span class="string">"width: 40%; height: 25px"</span>&gt;&lt;br&gt; &lt;br&gt; &lt;a</div><div class="line">				href=<span class="string">"javascript:void(0)"</span> style=<span class="string">"width: 30%; height: 25px"</span></div><div class="line">				onclick="sendMsg()"&gt;发送&lt;/a&gt;</div><div class="line">		&lt;/div&gt;</div><div class="line">	&lt;/div&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;script&gt;</div><div class="line">	<span class="function">function <span class="title">sendMsg</span><span class="params">()</span> </span>&#123;</div><div class="line">		messagePush.sendMessageAuto($(<span class="string">'#uid'</span>).val(), $(<span class="string">'#msg'</span>).val());</div><div class="line">		$(<span class="string">'#uid'</span>).val(<span class="string">''</span>);</div><div class="line">		$(<span class="string">'#msg'</span>).val(<span class="string">''</span>);</div><div class="line">	&#125;</div><div class="line">&lt;/script&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<p>me/util/MessagePushUtil.java中的内容</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> me.util;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Collection;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.servlet.ServletException;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</div><div class="line"><span class="keyword">import</span> org.directwebremoting.Browser;</div><div class="line"><span class="keyword">import</span> org.directwebremoting.ScriptBuffer;</div><div class="line"><span class="keyword">import</span> org.directwebremoting.ScriptSession;</div><div class="line"><span class="keyword">import</span> org.directwebremoting.ScriptSessionFilter;</div><div class="line"><span class="keyword">import</span> org.directwebremoting.WebContextFactory;</div><div class="line"></div><div class="line"><span class="keyword">import</span> me.message.MessagePushServlet;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessagePushUtil</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = Logger.getLogger(MessagePushUtil.class);</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPageLoad</span><span class="params">(String userID)</span> </span>&#123;</div><div class="line"></div><div class="line">		ScriptSession scriptSession = WebContextFactory.get().getScriptSession();</div><div class="line">		<span class="comment">// 工厂方法get()返回WebContext实例，通过WebContext获取servlet参数</span></div><div class="line">		<span class="comment">// ScriptSession与HttpSession类似</span></div><div class="line">		scriptSession.setAttribute(<span class="string">"uid"</span>, userID);</div><div class="line"></div><div class="line">		MessagePushServlet mpServlet = <span class="keyword">new</span> MessagePushServlet();</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			mpServlet.init();</div><div class="line">			LOGGER.info(String.format(<span class="string">"消息推送初始化成功，uid：%s"</span>, userID));</div><div class="line">		&#125; <span class="keyword">catch</span> (ServletException e) &#123;</div><div class="line">			LOGGER.error(String.format(<span class="string">"消息推送初始化错误，uid：%s"</span>, userID));</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line"><span class="comment">	 * 根据userID向指定用户推送消息</span></div><div class="line"><span class="comment">	 * </span></div><div class="line"><span class="comment">	 * <span class="doctag">@param</span> userID</span></div><div class="line"><span class="comment">	 * <span class="doctag">@param</span> autoMessage</span></div><div class="line"><span class="comment">	 */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessageAuto</span><span class="params">(String userID, String autoMessage)</span> </span>&#123;</div><div class="line"></div><div class="line">		<span class="keyword">final</span> String uid = userID;</div><div class="line">		<span class="keyword">final</span> String message = autoMessage;</div><div class="line"></div><div class="line">		Browser.withAllSessionsFiltered(<span class="keyword">new</span> ScriptSessionFilter() &#123;</div><div class="line">			<span class="comment">// 实现过滤器中的match()方法</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">match</span><span class="params">(ScriptSession session)</span> </span>&#123;</div><div class="line">				<span class="keyword">if</span> (session.getAttribute(<span class="string">"uid"</span>) == <span class="keyword">null</span>)</div><div class="line">					<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">				<span class="keyword">else</span></div><div class="line">					<span class="keyword">return</span> (session.getAttribute(<span class="string">"uid"</span>)).equals(uid);</div><div class="line">			&#125;</div><div class="line">		&#125;, <span class="keyword">new</span> Runnable() &#123;</div><div class="line"></div><div class="line">			<span class="keyword">private</span> ScriptBuffer script = <span class="keyword">new</span> ScriptBuffer();</div><div class="line"></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">				<span class="comment">// 调用JSP中定义的showMessage()方法，实现消息的前端显示</span></div><div class="line">				script.appendCall(<span class="string">"showMessage"</span>, message);</div><div class="line">				Collection&lt;ScriptSession&gt; sessions = Browser.getTargetSessions();</div><div class="line">				<span class="keyword">for</span> (ScriptSession scriptSession : sessions) &#123;</div><div class="line">					scriptSession.addScript(script);</div><div class="line">				&#125;</div><div class="line">				LOGGER.info(String.format(<span class="string">"向用户推送消息，uid：%s，message：%s"</span>, uid, message));</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>me/message/MessagePushServlet.java中的内容，覆盖DwrServlet中的init()方法实现ScriptSession监听器，在页面中加入engine.js时，ScriptSession创建，默认由org.directwebremoting.impl.DefaultScriptSessionManager管理，当发生unload事件时，DefaultScriptSessionManager会被通知销毁ScriptSession。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> me.message;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.servlet.ServletException;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</div><div class="line"><span class="keyword">import</span> org.directwebremoting.Container;</div><div class="line"><span class="keyword">import</span> org.directwebremoting.ServerContextFactory;</div><div class="line"><span class="keyword">import</span> org.directwebremoting.WebContextFactory;</div><div class="line"><span class="keyword">import</span> org.directwebremoting.event.ScriptSessionEvent;</div><div class="line"><span class="keyword">import</span> org.directwebremoting.event.ScriptSessionListener;</div><div class="line"><span class="keyword">import</span> org.directwebremoting.extend.ScriptSessionManager;</div><div class="line"><span class="keyword">import</span> org.directwebremoting.servlet.DwrServlet;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessagePushServlet</span> <span class="keyword">extends</span> <span class="title">DwrServlet</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">4298890285665323894L</span>;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = Logger.getLogger(MessagePushServlet.class);</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> ServletException </span>&#123;</div><div class="line"></div><div class="line">		Container container = ServerContextFactory.get().getContainer();</div><div class="line">		<span class="comment">// 工厂方法get()返回ServerContext实例</span></div><div class="line">		ScriptSessionManager manager = container.getBean(ScriptSessionManager.class);</div><div class="line">		ScriptSessionListener listener = <span class="keyword">new</span> ScriptSessionListener() &#123;</div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sessionCreated</span><span class="params">(ScriptSessionEvent ev)</span> </span>&#123;</div><div class="line">				HttpSession session = WebContextFactory.get().getSession();</div><div class="line"></div><div class="line">				String userID = (String) session.getAttribute(<span class="string">"uid"</span>);</div><div class="line">				LOGGER.info(<span class="string">"a ScriptSession is created"</span>);</div><div class="line">				ev.getSession().setAttribute(<span class="string">"uid"</span>, userID);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sessionDestroyed</span><span class="params">(ScriptSessionEvent ev)</span> </span>&#123;</div><div class="line">				LOGGER.info(<span class="string">"a ScriptSession is distroyed"</span>);</div><div class="line">			&#125;</div><div class="line">		&#125;;</div><div class="line">		manager.addScriptSessionListener(listener);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行前还要修改Tomcat下的server.xml中的配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!--</span></div><div class="line"><span class="comment">&lt;Connector connectionTimeout="20000" port="8080" </span></div><div class="line"><span class="comment">protocol="HTTP/1.1" redirectPort="8443"/&gt;</span></div><div class="line"><span class="comment">--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">URIEncoding</span>=<span class="string">"UTF-8"</span> <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span> <span class="attr">port</span>=<span class="string">"8080"</span></span></div><div class="line"><span class="tag"><span class="attr">protocol</span>=<span class="string">"org.apache.coyote.http11.Http11NioProtocol"</span> <span class="attr">redirectPort</span>=<span class="string">"8443"</span>/&gt;</span></div></pre></td></tr></table></figure>
<p>运行项目，打开<a href="http://localhost:8080/receiver.jsp" target="_blank" rel="external">http://localhost:8080/receiver.jsp</a>，页面加载时，调用</p>
<blockquote>
<p>   messagePush.onPageLoad(‘&lt;%=session.getAttribute(“uid”)%&gt;’);</p>
</blockquote>
<p>调用服务端的me.util.MessagePushUtil.onPageLoad(String userID)方法，初始化成功（可以使用字符串，如”123456789”,替换’&lt;%=session.getAttribute(“uid”)%&gt;’）。打开<a href="http://localhost:8080/sender.jsp" target="_blank" rel="external">http://localhost:8080/sender.jsp</a>，填写刚才的uid（123456789）和消息内容，点击发送，调用</p>
<blockquote>
<p>   messagePush.sendMessageAuto($(‘#uid’).val(), $(‘#msg’).val());</p>
</blockquote>
<p>调用服务端的me.util.MessagePushUtil.sendMessageAuto(String userID, String autoMessage)方法，调用receiver.jsp的showMessage(autoMessage)方法，可以在接收页面看到来自服务端推送的消息。</p>
<p>页面预览如下，</p>
<p><img src="https://moetu.fastmirror.org/images/2017/09/20/dwr-sender9ad2850a84ecc3bf.png" alt="发送页面"><br><img src="https://moetu.fastmirror.org/images/2017/09/20/dwr-receivercd5d8338dff261be.png" alt="接收页面"></p>
<p>除此之外，在log4j.properties中添加类似的配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">log4j.rootCategory=INFO, console</div><div class="line">log4j.category.org.directwebremoting.log=INFO, dwr, console</div><div class="line"></div><div class="line">log4j.appender.console=org.apache.log4j.ConsoleAppender</div><div class="line">log4j.appender.console.layout=org.apache.log4j.PatternLayout</div><div class="line">log4j.appender.console.layout.ConversionPattern=[%5p] %d&#123;yyyy-MM-dd HH:mm:ss&#125; %l - %m%n</div><div class="line"></div><div class="line">log4j.appender.dwr=org.apache.log4j.RollingFileAppender</div><div class="line">log4j.appender.dwr.File=../logs/dwr.log</div><div class="line">log4j.appender.dwr.MaxFileSize=100KB</div><div class="line">log4j.appender.dwr.MaxBackupIndex=1</div><div class="line">log4j.appender.dwr.layout=org.apache.log4j.PatternLayout</div><div class="line">log4j.appender.dwr.layout.ConversionPattern=[%5p] %d&#123;yyyy-MM-dd HH:mm:ss&#125; %l - %m%n</div></pre></td></tr></table></figure>
<p>#####参考资料</p>
<p><a href="http://wang371134086.iteye.com/blog/1849716" target="_blank" rel="external">DWR3实现服务器端向客户端精确推送消息</a></p>
<p><a href="http://jemoii.github.io/blog/getting-started-with-dwr/" target="_blank" rel="external">DWR简单入门</a></p>
<p><a href="http://directwebremoting.org/dwr/documentation/reverse-ajax/index.html" target="_blank" rel="external">Reverse Ajax</a></p>
<p><a href="http://directwebremoting.org/dwr/documentation/server/logging.html" target="_blank" rel="external">Logging</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/commons-email-and-spring/" class="prev">上一篇</a><a href="/annotation-for-struts2-tags/" class="next">下一篇</a></div><div class="copyright"><p>© 2014 - 2017 <a href="https://g.hijkl.mn">Jemoii</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>